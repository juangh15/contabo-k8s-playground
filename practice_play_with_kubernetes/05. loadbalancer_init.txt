# Replace the content with the command got from control_plane
cat <<'EOF' > kubeconfig-external.yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: 123123
    server: https://192.168.0.8:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: 123123
    client-key-data: 123123

EOF


# Get Ips
cat <<'EOF' > get_worker_ips.sh
kubectl --kubeconfig=./kubeconfig-external.yaml get nodes -o jsonpath='{.items[*].metadata.name}{"\n"}' \
  | grep -o 'worker-node[0-9]\+' \
  | xargs -I {} kubectl --kubeconfig=./kubeconfig-external.yaml get node {} -o jsonpath='{.status.addresses[?(@.type=="InternalIP")].address}{"\n"}'
EOF


# Loadbalancer Init
cat <<'EOF' > loadbalancer_init.sh
# Install basic tools
echo -e "[base]\nname=CentOS-$releasever - Base\nbaseurl=http://vault.centos.org/centos/7/os/x86_64/\nenabled=1\ngpgcheck=1\ngpgkey=http://vault.centos.org/centos/RPM-GPG-KEY-CentOS-7" | tee /etc/yum.repos.d/CentOS-Base.repo
rm -rf /etc/yum.repos.d/kubernetes.repo
yum clean all
yum install unzip nano sudo openssl strace -y

mkdir -p /etc/nginx/conf.d/
echo "events{} http{ server { listen 80; location / { root /usr/share/nginx/html; } } }" > /etc/nginx/conf.d/nginx.conf

docker container rm -f nginx-lb 2>/dev/null
docker run -d --name nginx-lb -p 80:80 \
  -v /etc/nginx/conf.d/nginx.conf:/etc/nginx/nginx.conf:ro nginx
EOF


# Execution Phase
. loadbalancer_init.sh

